"use strict";function ownKeys(r,e){var n,t=Object.keys(r);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(r),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)),t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(r,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(n,e))})}return r}function _defineProperty(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function asyncGeneratorStep(e,r,n,t,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?r(c):Promise.resolve(c).then(t,i)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(r,n){var t=s.apply(e,a);function i(e){asyncGeneratorStep(t,r,n,i,o,"next",e)}function o(e){asyncGeneratorStep(t,r,n,i,o,"throw",e)}i(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,r,n){return r&&_defineProperties(e.prototype,r),n&&_defineProperties(e,n),e}var divAliceMessage=document.getElementById("Alice"),divBobMessage=document.getElementById("Bob"),KeyHelper=libsignal.KeyHelper,bobPreKeyId=1337,alicePreKeyId=333,bobSignedKeyId=100,aliceStore=new SignalProtocolStore,bobStore=new SignalProtocolStore,BobConfig={userName:"Bob",preKeyId:bobPreKeyId,signedKeyId:bobSignedKeyId,address:new libsignal.SignalProtocolAddress("bob",bobPreKeyId),store:bobStore},AliceConfig={userName:"Alice",preKeyId:alicePreKeyId,signedKeyId:101,address:new libsignal.SignalProtocolAddress("alice",alicePreKeyId),store:aliceStore},ALICE_ADDRESS=AliceConfig.address,BOB_ADDRESS=BobConfig.address,Person=function(){function n(e,r){_classCallCheck(this,n),this.ctn=e,this.config=r,this.init()}var t;return _createClass(n,[{key:"getReceiver",value:function(e){return"Bob"==e?BobConfig:AliceConfig}},{key:"init",value:function(){this.render()}},{key:"render",value:function(){var e=this.config,r=e.preKeyId,n=e.signedKeyId,t=e.address;this.ctn.innerHTML+="\n            <p>生成预共享密钥对Id（preKeyId）".concat(r,"</p>\n            <p>用预共享密钥生成的地址：").concat(t,"</p>\n            <p>生成签名密钥的signKeyId：").concat(n,"</p>\n            <p></p>"),this.attchEvent()}},{key:"attchEvent",value:function(){var t=this;document.getElementById("".concat(this.config.userName,"Mes")).addEventListener("click",function(){var e=t.ctn.querySelector(".message").value,r=util.toArrayBuffer(e),r=e,n=t.getReceiver(t.config.receiver);t.ctn.innerHTML+="<p>".concat(t.config.userName," send: ").concat(e,"</p>"),t.bulidMessage(n,r)},!1)}},{key:"bulidMessage",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(n,t){var r,i,o=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,genIdentityRegistrator(this.config.store,this.ctn);case 2:return e.next=4,genIdentityRegistrator(n.store,divBobMessage);case 4:return e.next=6,generatePreKeyBundle(n.store,n.preKeyId,n.signedKeyId);case 6:return r=e.sent,i=new libsignal.SessionBuilder(this.config.store,BOB_ADDRESS),e.abrupt("return",i.processPreKey(r).then(function(){var e=new libsignal.SessionCipher(o.config.store,BOB_ADDRESS),r=new libsignal.SessionCipher(n.store,ALICE_ADDRESS);e.encrypt(t).then(function(e){return r.decryptPreKeyWhisperMessage(e.body,"binary")}).then(function(e){divBobMessage.innerHTML+="<p>".concat(n.userName,"接受的内容是：").concat(util.toString(e),"</p>")})}));case 9:case"end":return e.stop()}},e,this)})),function(e,r){return t.apply(this,arguments)})}]),n}();function genIdentityRegistrator(e,r){return _genIdentityRegistrator.apply(this,arguments)}function _genIdentityRegistrator(){return(_genIdentityRegistrator=_asyncToGenerator(regeneratorRuntime.mark(function e(r,n){var t,i,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,KeyHelper.generateIdentityKeyPair();case 3:return t=e.sent,e.next=6,KeyHelper.generateRegistrationId();case 6:i=e.sent,r.put("identityKey",t),r.put("registrationId",i),o=t.pubKey,a=t.privKey,n.innerHTML+="<p> identityKey 公钥:".concat(o," 私钥:").concat(a,"</p>\n                            <p>registrationId: ").concat(result[1],"</p>"),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),console.log(e.t0);case 16:case"end":return e.stop()}},e,null,[[0,13]])}))).apply(this,arguments)}function generatePreKeyBundle(e,r,n){return _generatePreKeyBundle.apply(this,arguments)}function _generatePreKeyBundle(){return(_generatePreKeyBundle=_asyncToGenerator(regeneratorRuntime.mark(function e(r,n,t){var i,o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.getIdentityKeyPair();case 2:return i=e.sent,e.next=5,r.getLocalRegistrationId();case 5:return o=e.sent,e.next=8,KeyHelper.generatePreKey(n);case 8:return a=e.sent,e.next=11,KeyHelper.generateSignedPreKey(i,t);case 11:return s=e.sent,r.storePreKey(n,a.keyPair),r.storeSignedPreKey(t,s.keyPair),e.abrupt("return",{identityKey:i.pubKey,registrationId:o,preKey:{keyId:n,publicKey:a.keyPair.pubKey},signedPreKey:{keyId:t,publicKey:s.keyPair.pubKey,signature:s.signature}});case 15:case"end":return e.stop()}},e)}))).apply(this,arguments)}new Person(divAliceMessage,_objectSpread(_objectSpread({},AliceConfig),{},{receiver:"Bob"})),new Person(divBobMessage,_objectSpread(_objectSpread({},BobConfig),{},{receiver:"Alice"}));